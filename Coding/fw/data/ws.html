<!--
  (c) NewTec GmbH 2020   -   www.newtec.de
  $URL: https://github.com/NewTec-GmbH/esp32-can-iot $
-->
<!DOCTYPE HTML>
<html>

<head>
    <title>ESP Web Server</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="/css/style.css" />
    <script src="/js/ws.js"></script>
    <script>
        var logMessages = [];
        var maxLogs = 40;
        var counter = 1;
        var enable = 1;

        var gateway = `ws://${window.location.hostname}/ws`;
        var websocket;
        window.addEventListener('load', onLoad);

        function initWebSocket() {
            console.log('Trying to open a WebSocket connection...');
            websocket = new WebSocket(gateway);
            websocket.onopen = onOpen;
            websocket.onclose = onClose;
            websocket.onmessage = onMessage;
        }

        function onOpen(event) {
            console.log('Connection opened');
            websocket.send("D\r");
        }

        function onClose(event) {
            console.log('Connection closed');
            setTimeout(initWebSocket, 2000);
        }

        function onLoad(event) {
            initWebSocket();
            setInterval(getCMD, 10);
        }

        function onMessage(event) {
            logMessages.push(event.data);
        }

        function getCMD() {
            if (logMessages.length != 0) {

                console.log(logMessages[0]);

                switch (logMessages[0][0]) {
                    case '\r':
                        console.log("OK");
                        break;
                    case '\a':
                        console.log("Error");
                        break;

                    case "t":
                    case "T":
                    case "r":
                    case "R":
                        displayMessages();
                        break;

                    case "D":
                        displaySettings();
                        break;

                    default:
                        console.log("Unrecognized Lawicel Command");
                        break;
                }
                logMessages.shift();
            }
        }

        function displayMessages() {
            if (enable == 1) {

                var table = document.getElementById("CANLog");
                var row = null;
                var cell = null;

                var frame = {
                    ID: "",
                    RTR: "-",
                    DLC: "",
                    DATA: "",
                    BYTES: ["-", "-", "-", "-", "-", "-", "-", "-"],
                    TIMESTAMP: "",
                    SYSTIME: ""
                };

                switch (logMessages[0][0]) {
                    case "t":
                        frame.ID = logMessages[0].substr(1, 3);
                        frame.DLC = logMessages[0][4];
                        frame.DATA = logMessages[0].substr(5, frame.DLC * 2);
                        frame.TIMESTAMP = logMessages[0].substr(5 + frame.DLC * 2, 4);
                        frame.SYSTIME = logMessages[0].substr(9 + frame.DLC * 2, 6);
                        break;

                    case "T":
                        frame.ID = logMessages[0].substr(1, 8);
                        frame.DLC = logMessages[0][9];
                        frame.DATA = logMessages[0].substr(10, frame.DLC * 2);
                        frame.TIMESTAMP = logMessages[0].substr(10 + frame.DLC * 2, 4);
                        frame.SYSTIME = logMessages[0].substr(14 + frame.DLC * 2, 6);
                        break;

                    case "r":
                        frame.ID = logMessages[0].substr(1, 3);
                        frame.RTR = "Yes";
                        frame.TIMESTAMP = logMessages[0].substr(5, 4);
                        frame.SYSTIME = logMessages[0].substr(9, 6);
                        break;

                    case "R":
                        frame.ID = logMessages[0].substr(1, 8);
                        frame.RTR = "Yes";
                        frame.DLC = logMessages[0][9];
                        frame.TIMESTAMP = logMessages[0].substr(10, 4);
                        frame.SYSTIME = logMessages[0].substr(14, 8);
                        break;

                    default:
                        frame.ID = undefined;
                        frame.DLC = undefined;
                        frame.DATA = undefined;
                        frame.TIMESTAMP = undefined;
                        frame.SYSTIME = undefined;
                        break;
                }

                if (frame.RTR == "-") {

                    var position = 0;
                    var byte = 0;
                    frame.DATA.toUpperCase();

                    while (position < (frame.DLC * 2)) {
                        frame.BYTES[byte] = frame.DATA.substr(position, 2);
                        byte++;
                        position = position + 2;
                    }
                }

                if (maxLogs < table.rows.length) {
                    table.deleteRow(-1);
                }

                row = table.insertRow(1);

                cell = row.insertCell(-1);
                cell.innerHTML = counter;
                cell = row.insertCell(-1);
                cell.innerHTML = frame.ID;
                cell = row.insertCell(-1);
                cell.innerHTML = frame.RTR;
                cell = row.insertCell(-1);
                cell.innerHTML = frame.DLC;
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[0];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[1];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[2];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[3];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[4];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[5];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[6];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.BYTES[7];
                cell = row.insertCell(-1);
                cell.innerHTML = frame.TIMESTAMP.toUpperCase();
                cell = row.insertCell(-1);
                cell.innerHTML = frame.SYSTIME;

                counter++;

            }
        }

        function displaySettings() {
            var temp = document.getElementById("Sys_Auto");
            temp.innerHTML = logMessages[0][1];
            temp = document.getElementById("Sys_CBaud");
            temp.innerHTML = logMessages[0].substr(2, 2);
            temp = document.getElementById("Sys_TStmp");
            temp.innerHTML = logMessages[0][4];
        }

        function sendCMD() {
            var input = document.getElementById("LawicelCMD").value;
            input += '\r';
            console.log(input);
            websocket.send(input);
        }

        function toggle() {
            enable = !enable;
            console.log("Button Toggled");
        }
    </script>

</head>

<body>
    <div class="topnav">
        <a href="/">Home</a>
    </div>
    <h1>CAN Communication</h1>

    <div>
        <form>
            <label for="LawicelCMD">Lawicel Command:</label><br>
            <input type="text" id="LawicelCMD" name="LawicelCMD" placeholder="LawicelCMD"><br>
        </form>
        <button type="button" onclick="sendCMD()">Send</button>
    </div>

    <div>
        <table id="SystemData" cellpadding="15px">
            <tr>
                <th>AutoStart</th>
                <th>CAN Baudrate</th>
                <th>Timestamp</th>
            </tr>
            <tr>
                <td id="Sys_Auto"></td>
                <td id="Sys_CBaud"></td>
                <td id="Sys_TStmp"></td>
            </tr>
        </table>
    </div>

    <div>
        <button class="button" type="button" onclick="toggle()">Pause</button>
        <div>
            <table id="CANLog" cellpadding="15px">
                <tr>
                    <th>Msg</th>
                    <th>ID</th>
                    <th>RTR</th>
                    <th>DLC</th>
                    <th>Byte 1</th>
                    <th>Byte 2</th>
                    <th>Byte 3</th>
                    <th>Byte 4</th>
                    <th>Byte 5</th>
                    <th>Byte 6</th>
                    <th>Byte 7</th>
                    <th>Byte 8</th>
                    <th>Timestamp</th>
                    <th>SysTime</th>
                </tr>
            </table>
        </div>
    </div>
</body>

</html>